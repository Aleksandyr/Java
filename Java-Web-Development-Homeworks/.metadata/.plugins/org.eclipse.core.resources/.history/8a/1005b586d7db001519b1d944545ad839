package bg.jwd.bankAcc.controllers;

import java.util.ArrayList;
import java.util.List;
import java.util.Locale;

import javax.servlet.http.HttpServletRequest;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;

import bg.jwd.bankAcc.entities.User;
import bg.jwd.bankAcc.services.BankAccountService;

@Controller
public class BankAccountController {

	@Autowired
	private BankAccountService bankAccService;

	private List<User> users = new ArrayList<>();

	public BankAccountController() {
		this.initializeUsers();
	}

	// @Autowired
	// private ReqisterService reqisterService;

	@RequestMapping(value = "/", method = RequestMethod.GET)
	public String home(Locale locale, Model model) {

		return "home";
	}

	@RequestMapping(value = "/checkStudent", method = RequestMethod.POST)
	public String checkStudent(Model model, @ModelAttribute("user") User user, HttpServletRequest request) {
		/*
		 * String username = (String) request.getAttribute("client_name");
		 * 
		 * String password = (String) request.getAttribute("asd");
		 * System.out.println(password);
		 */

		return "checkStudent";
	}

	@RequestMapping(value = "/bankOperation", method = RequestMethod.POST)
	public String bankOperation(Model model, @ModelAttribute("user") User user, HttpServletRequest request)
			throws Exception {
		String username = user.getName();
		User getUser = null;

		for (User currUser : this.users) {
			if (currUser.getName().equals(username)) {
				getUser = currUser;
			}
		}

		// Reqister new user
		if (getUser == null) {
			User newUser = new User();
			newUser.setName(username);
			this.users.add(newUser);
			getUser = newUser;
		}

		String operation = request.getParameter("deposit_withdraw");
		String amountToChange = request.getParameter("amount_to_change");
		double convertedAmount = Double.parseDouble(amountToChange);

		if (operation.equals("deposit")) {
			this.bankAccService.deposite(getUser, convertedAmount);
		} else if (operation.equals("withdraw")) {
			this.bankAccService.withdraw(getUser, convertedAmount, request);
		}

		request.getSession().setAttribute("client_name", username);
		request.getSession().setAttribute("amount_to_change", getUser.getAmount());

		return "home";
	}

	private void initializeUsers() {
		User user1 = new User();
		user1.setId(1);
		user1.setName("pesho");
		user1.setAmount(1000);

		User user2 = new User();
		user2.setId(2);
		user2.setName("misho");
		user2.setAmount(1000);

		User user3 = new User();
		user3.setId(3);
		user3.setName("tosho");
		user3.setAmount(1000);

		this.users.add(user1);
		this.users.add(user2);
		this.users.add(user3);
	}
}
